<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login Page</title>
    <!-- Tailwind CSS CDN for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS to ensure Inter font family is used */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Message box for displaying success/error messages */
        .message-box {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: bold;
            z-index: 1000;
            display: none; /* Hidden by default */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            animation: fadein 0.5s, fadeout 0.5s 2.5s;
        }

        .message-box.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .message-box.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @keyframes fadein {
            from {top: 0; opacity: 0;}
            to {top: 20px; opacity: 1;}
        }

        @keyframes fadeout {
            from {top: 20px; opacity: 1;}
            to {top: 0; opacity: 0;}
        }
    </style>
</head>
<body class="bg-gradient-to-r from-blue-400 to-purple-500 min-h-screen flex items-center justify-center p-4">

    <!-- Message Box for displaying status -->
    <div id="messageBox" class="message-box"></div>

    <!-- Main container for the login card -->
    <div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
        <h2 class="text-4xl font-extrabold text-center text-gray-800 mb-8">Login</h2>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-6">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700 mb-2">Email address</label>
                <input
                    type="email"
                    id="email"
                    name="email"
                    autocomplete="email"
                    required
                    class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                    placeholder="you@example.com"
                />
            </div>

            <div>
                <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                <input
                    type="password"
                    id="password"
                    name="password"
                    autocomplete="current-password"
                    required
                    class="appearance-none block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition duration-200"
                    placeholder="••••••••"
                />
            </div>

            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <input
                        id="remember-me"
                        name="remember-me"
                        type="checkbox"
                        class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                    />
                    <label for="remember-me" class="ml-2 block text-sm text-gray-900">Remember me</label>
                </div>

                <div class="text-sm">
                    <a href="#" class="font-medium text-blue-600 hover:text-blue-500 transition duration-200">
                        Forgot your password?
                    </a>
                </div>
            </div>

            <div>
                <button
                    type="submit"
                    id="signInButton"
                    class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-lg font-semibold text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-200 transform hover:scale-105"
                >
                    Sign in
                </button>
            </div>
        </form>

        <!-- Or separator -->
        <div class="relative mt-8 mb-6">
            <div class="absolute inset-0 flex items-center" aria-hidden="true">
                <div class="w-full border-t border-gray-300"></div>
            </div>
            <div class="relative flex justify-center text-sm">
                <span class="px-2 bg-white text-gray-500">Or continue with</span>
            </div>
        </div>

        <!-- Social login buttons -->
        <div class="grid grid-cols-2 gap-3">
            <button
                type="button"
                class="w-full inline-flex justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-base font-medium text-gray-500 hover:bg-gray-50 transition duration-200 transform hover:scale-105"
            >
                <img src="https://upload.wikimedia.org/wikipedia/commons/4/4a/Logo_of_Google_G_Suite.png" alt="Google logo" class="w-5 h-5 mr-2" onerror="this.src='https://placehold.co/20x20/cccccc/333333?text=G'">
                Google
            </button>
            <button
                type="button"
                class="w-full inline-flex justify-center py-3 px-4 border border-gray-300 rounded-lg shadow-sm bg-white text-base font-medium text-gray-500 hover:bg-gray-50 transition duration-200 transform hover:scale-105"
            >
                <img src="https://upload.wikimedia.org/wikipedia/commons/0/05/Facebook_Logo_%282019%29.png" alt="Facebook logo" class="w-5 h-5 mr-2" onerror="this.src='https://placehold.co/20x20/cccccc/333333?text=F'">
                Facebook
            </button>
        </div>

        <!-- Sign up link -->
        <p class="mt-8 text-center text-sm text-gray-600">
            Don't have an account?
            <a href="#" class="font-medium text-blue-600 hover:text-blue-500 transition duration-200">
                Sign up
            </a>
        </p>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, signInWithCustomToken, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase configuration (provided by the environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app;
        let auth;
        let db;
        let currentUserId = null; // To store the current user ID

        /**
         * Displays a message box with the given message and type (success or error).
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error'.
         */
        function showMessageBox(message, type) {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = `message-box ${type}`; // Apply classes for styling
            messageBox.style.display = 'block'; // Show the message box

            // Hide the message box after 3 seconds
            setTimeout(() => {
                messageBox.style.display = 'none';
            }, 3000);
        }

        /**
         * Initializes Firebase app, authentication, and Firestore.
         * Handles custom token sign-in or anonymous sign-in.
         */
        async function initializeFirebase() {
            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Listen for authentication state changes
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in
                        currentUserId = user.uid;
                        console.log("User is signed in:", currentUserId);
                        // For multi-user apps, it is MANDATORY to show the complete userId string on the main UI.
                        // For this login page example, we can show it here for demonstration or in a profile area.
                        // You might want to update a UI element to display the user ID after successful login.
                        // Example: document.getElementById('userIdDisplay').textContent = `User ID: ${currentUserId}`;
                    } else {
                        // User is signed out
                        currentUserId = null;
                        console.log("User is signed out.");
                    }
                });

                // Sign in with custom token if available, otherwise sign in anonymously
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Signed in with custom token.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Signed in anonymously.");
                }

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showMessageBox(`Firebase initialization error: ${error.message}`, 'error');
            }
        }

        // Initialize Firebase when the window loads
        window.onload = initializeFirebase;


        // Get form elements
        const loginForm = document.getElementById('loginForm');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const signInButton = document.getElementById('signInButton');

        // Add event listener for form submission
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault(); // Prevent default form submission

            const email = emailInput.value;
            const password = passwordInput.value;

            if (!auth) {
                showMessageBox('Firebase Auth not initialized. Please try again.', 'error');
                console.error("Firebase Auth not initialized.");
                return;
            }

            try {
                // Attempt to sign in with email and password
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const user = userCredential.user;
                showMessageBox(`Successfully signed in as ${user.email}!`, 'success');
                console.log("User signed in:", user.uid);

                // Optionally, store some user data in Firestore upon successful login
                // This is an example; you might have a dedicated user registration process
                const userRef = doc(db, `artifacts/${appId}/users/${user.uid}/user_data/profile`);
                await setDoc(userRef, {
                    email: user.email,
                    lastLogin: new Date().toISOString(),
                    // Add other user details you want to store
                }, { merge: true }); // Use merge to update existing fields without overwriting the whole document
                console.log("User profile updated in Firestore.");

            } catch (error) {
                // Handle different error codes for better user feedback
                let errorMessage = "An unknown error occurred during login.";
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = "Invalid email or password.";
                        break;
                    case 'auth/invalid-email':
                        errorMessage = "Please enter a valid email address.";
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = "Too many login attempts. Please try again later.";
                        break;
                    default:
                        errorMessage = `Login failed: ${error.message}`;
                        break;
                }
                showMessageBox(errorMessage, 'error');
                console.error("Login error:", error);
            }
        });
    </script>
</body>
</html>
